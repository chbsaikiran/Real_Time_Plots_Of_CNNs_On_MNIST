<!DOCTYPE html>
<html>
<head>
    <title>MNIST CNN Models Comparison</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>MNIST CNN Models Comparison</h1>
        
        <div class="main-content">
            <!-- Left Column -->
            <div class="left-column">
                <div class="models-config">
                    <div class="model-config">
                        <h2>Model 1 Configuration</h2>
                        <form id="model1-form">
                            <div class="form-group">
                                <label>Conv1 Layers:</label>
                                <input type="number" name="model1_conv1" value="16" min="1">
                            </div>
                            <div class="form-group">
                                <label>Conv2 Layers:</label>
                                <input type="number" name="model1_conv2" value="32" min="1">
                            </div>
                            <div class="form-group">
                                <label>Conv3 Layers:</label>
                                <input type="number" name="model1_conv3" value="64" min="1">
                            </div>
                            <div class="form-group">
                                <label>Optimizer:</label>
                                <select name="model1_optimizer">
                                    <option value="adam">Adam</option>
                                    <option value="sgd">SGD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Batch Size:</label>
                                <input type="number" name="model1_batch_size" value="64" min="1">
                            </div>
                            <div class="form-group">
                                <label>Epochs:</label>
                                <input type="number" name="model1_epochs" value="5" min="1">
                            </div>
                        </form>
                    </div>
                    
                    <div class="model-config">
                        <h2>Model 2 Configuration</h2>
                        <form id="model2-form">
                            <div class="form-group">
                                <label>Conv1 Layers:</label>
                                <input type="number" name="model2_conv1" value="8" min="1">
                            </div>
                            <div class="form-group">
                                <label>Conv2 Layers:</label>
                                <input type="number" name="model2_conv2" value="8" min="1">
                            </div>
                            <div class="form-group">
                                <label>Conv3 Layers:</label>
                                <input type="number" name="model2_conv3" value="8" min="1">
                            </div>
                            <div class="form-group">
                                <label>Optimizer:</label>
                                <select name="model2_optimizer">
                                    <option value="adam">Adam</option>
                                    <option value="sgd">SGD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Batch Size:</label>
                                <input type="number" name="model2_batch_size" value="64" min="1">
                            </div>
                            <div class="form-group">
                                <label>Epochs:</label>
                                <input type="number" name="model2_epochs" value="5" min="1">
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="button-group">
                    <button id="train-button" onclick="startTraining()">Train Models</button>
                    <button id="stop-button" onclick="stopTraining()" disabled>Stop Training</button>
                </div>
                
                <div class="progress-container">
                    <div class="progress-section">
                        <h3>Model 1 Progress</h3>
                        <div class="progress">
                            <div id="progress1" class="progress-bar" style="width: 0%">0%</div>
                        </div>
                        <div id="status1" class="training-status">Starting training...</div>
                        <div id="metrics1" class="metrics">
                            <span class="loss">Loss: -</span>
                            <span class="accuracy">Accuracy: -</span>
                            <span class="learning-rate">LR: -</span>
                        </div>
                        <div id="timer1" class="timer">Time: 00:00:00</div>
                    </div>
                    <div class="progress-section">
                        <h3>Model 2 Progress</h3>
                        <div class="progress">
                            <div id="progress2" class="progress-bar" style="width: 0%">0%</div>
                        </div>
                        <div id="status2" class="training-status">Starting training...</div>
                        <div id="metrics2" class="metrics">
                            <span class="loss">Loss: -</span>
                            <span class="accuracy">Accuracy: -</span>
                            <span class="learning-rate">LR: -</span>
                        </div>
                        <div id="timer2" class="timer">Time: 00:00:00</div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <div class="plots-section">
                    <h2 class="section-heading">Training Metrics</h2>
                    <div class="plots-container">
                        <div class="plot">
                            <h3>Training Loss</h3>
                            <div id="train-loss-plot" style="width:100%; height:400px;"></div>
                        </div>
                        <div class="plot">
                            <h3>Training Accuracy</h3>
                            <div id="train-acc-plot" style="width:100%; height:400px;"></div>
                        </div>
                    </div>

                    <h2 class="section-heading">Validation Metrics</h2>
                    <div class="plots-container">
                        <div class="plot">
                            <h3>Validation Loss</h3>
                            <div id="val-loss-plot" style="width:100%; height:400px;"></div>
                        </div>
                        <div class="plot">
                            <h3>Validation Accuracy</h3>
                            <div id="val-acc-plot" style="width:100%; height:400px;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="test-button" onclick="showTestResults()">Test Results</button>
                    <button id="train-metrics-button" onclick="showModelMetrics('train')">Training Metrics</button>
                    <button id="test-metrics-button" onclick="showModelMetrics('test')">Test Metrics</button>
                </div>

                <div id="test-results" class="test-results" style="display: none;">
                    <h2>Test Results</h2>
                    <div class="results-grid"></div>
                </div>

                <div id="model-metrics" class="model-metrics" style="display: none;">
                    <h2>Model Metrics</h2>
                    <div class="metrics-container">
                        <div class="model-metric">
                            <h3>Model 1 Confusion Matrix</h3>
                            <div id="confusion-matrix1"></div>
                            <div id="model1-scores" class="score-metrics"></div>
                        </div>
                        <div class="model-metric">
                            <h3>Model 2 Confusion Matrix</h3>
                            <div id="confusion-matrix2"></div>
                            <div id="model2-scores" class="score-metrics"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script>
        let socket;
        const model1Data = {
            train_losses: [],
            train_accuracies: [],
            val_losses: [],
            val_accuracies: []
        };
        const model2Data = {
            train_losses: [],
            train_accuracies: [],
            val_losses: [],
            val_accuracies: []
        };

        let startTime1 = null;
        let startTime2 = null;
        let timer1Interval = null;
        let timer2Interval = null;
        let isTraining = false;

        function formatTime(ms) {
            let seconds = Math.floor(ms / 1000);
            let minutes = Math.floor(seconds / 60);
            let hours = Math.floor(minutes / 60);
            
            seconds = seconds % 60;
            minutes = minutes % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateTimer1() {
            if (startTime1) {
                const elapsed = Date.now() - startTime1;
                document.getElementById('timer1').textContent = `Time: ${formatTime(elapsed)}`;
            }
        }

        function updateTimer2() {
            if (startTime2) {
                const elapsed = Date.now() - startTime2;
                document.getElementById('timer2').textContent = `Time: ${formatTime(elapsed)}`;
            }
        }

        function initPlots() {
            const commonTrace1 = {
                name: 'Model 1',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#3498db'}
            };
            
            const commonTrace2 = {
                name: 'Model 2',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#e74c3c'}
            };

            const commonLayout = {
                showlegend: true,
                legend: {
                    x: 1.05,
                    xanchor: 'left',
                    y: 1,
                    yanchor: 'top',
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#E2E2E2',
                    borderwidth: 1
                },
                margin: {
                    l: 60,
                    r: 80,
                    t: 50,
                    b: 80
                },
                font: {
                    family: 'Segoe UI, sans-serif',
                    size: 12,
                    color: '#2c3e50'
                },
                width: null,
                height: 350,
                autosize: true
            };

            // Training Loss Plot
            Plotly.newPlot('train-loss-plot', 
                [{...commonTrace1}, {...commonTrace2}], 
                {
                    ...commonLayout,
                    title: 'Training Loss',
                    xaxis: {
                        title: {
                            text: 'Batch (x250)',
                            font: { size: 12, color: '#2c3e50' },
                            standoff: 20
                        },
                        automargin: true
                    },
                    yaxis: {
                        title: {
                            text: 'Loss',
                            font: { size: 12, color: '#2c3e50' },
                            standoff: 20
                        },
                        automargin: true
                    }
                },
                {responsive: true}
            );

            // Training Accuracy Plot
            Plotly.newPlot('train-acc-plot', 
                [{...commonTrace1}, {...commonTrace2}], 
                {
                    ...commonLayout,
                    title: 'Training Accuracy',
                    xaxis: {
                        title: {
                            text: 'Batch (x250)',
                            font: { size: 12, color: '#2c3e50' },
                            standoff: 20
                        },
                        automargin: true
                    },
                    yaxis: {
                        title: {
                            text: 'Accuracy (%)',
                            font: { size: 12, color: '#2c3e50' },
                            standoff: 20
                        },
                        automargin: true
                    }
                },
                {responsive: true}
            );

            // Validation Loss Plot
            Plotly.newPlot('val-loss-plot', 
                [{...commonTrace1}, {...commonTrace2}], 
                {
                    ...commonLayout,
                    title: 'Validation Loss',
                    xaxis: {
                        title: {
                            text: 'Epochs',
                            font: { size: 12, color: '#2c3e50' },
                            standoff: 20
                        },
                        automargin: true
                    },
                    yaxis: {
                        title: {
                            text: 'Loss',
                            font: { size: 12, color: '#2c3e50' },
                            standoff: 20
                        },
                        automargin: true
                    }
                },
                {responsive: true}
            );

            // Validation Accuracy Plot
            Plotly.newPlot('val-acc-plot', 
                [{...commonTrace1}, {...commonTrace2}], 
                {
                    ...commonLayout,
                    title: 'Validation Accuracy',
                    xaxis: {
                        title: {
                            text: 'Epochs',
                            font: { size: 12, color: '#2c3e50' },
                            standoff: 20
                        },
                        automargin: true
                    },
                    yaxis: {
                        title: {
                            text: 'Accuracy (%)',
                            font: { size: 12, color: '#2c3e50' },
                            standoff: 20
                        },
                        automargin: true
                    }
                },
                {responsive: true}
            );
        }

        function updatePlots(data) {
            const modelData = data.model === 'model1' ? model1Data : model2Data;
            modelData.train_losses = data.train_losses;
            modelData.train_accuracies = data.train_accuracies;
            modelData.val_losses = data.val_losses;
            modelData.val_accuracies = data.val_accuracies;

            // Create layout update object with fixed axis ranges
            const layoutUpdate = {
                xaxis: {
                    title: {
                        text: 'Batch (x250)',
                        font: { size: 12, color: '#2c3e50' },
                        standoff: 20
                    },
                    automargin: true,
                    range: [0, Math.max(
                        model1Data.train_losses.length,
                        model2Data.train_losses.length
                    ) + 1]  // Add some padding
                }
            };

            // Update training loss plot
            Plotly.update('train-loss-plot', {
                'x': [
                    [...Array(model1Data.train_losses.length).keys()],
                    [...Array(model2Data.train_losses.length).keys()]
                ],
                'y': [model1Data.train_losses, model2Data.train_losses]
            }, layoutUpdate);

            // Update training accuracy plot
            Plotly.update('train-acc-plot', {
                'x': [
                    [...Array(model1Data.train_accuracies.length).keys()],
                    [...Array(model2Data.train_accuracies.length).keys()]
                ],
                'y': [model1Data.train_accuracies, model2Data.train_accuracies]
            }, layoutUpdate);

            // Update validation plots with different x-axis title
            const valLayoutUpdate = {
                xaxis: {
                    title: {
                        text: 'Epochs',
                        font: { size: 12, color: '#2c3e50' },
                        standoff: 20
                    },
                    automargin: true,
                    range: [0, Math.max(
                        model1Data.val_losses.length,
                        model2Data.val_losses.length
                    ) + 1]
                }
            };

            // Update validation loss plot
            Plotly.update('val-loss-plot', {
                'x': [
                    [...Array(model1Data.val_losses.length).keys()],
                    [...Array(model2Data.val_losses.length).keys()]
                ],
                'y': [model1Data.val_losses, model2Data.val_losses]
            }, valLayoutUpdate);

            // Update validation accuracy plot
            Plotly.update('val-acc-plot', {
                'x': [
                    [...Array(model1Data.val_accuracies.length).keys()],
                    [...Array(model2Data.val_accuracies.length).keys()]
                ],
                'y': [model1Data.val_accuracies, model2Data.val_accuracies]
            }, valLayoutUpdate);
        }

        async function startTraining() {
            if (isTraining) {
                return;
            }
            
            try {
                // Reset UI state first
                resetUI();
                
                // Setup WebSocket connection
                if (socket) {
                    socket.close();
                }
                socket = io();
                
                // Setup all socket listeners before starting training
                socket.on('plot_update', function(data) {
                    if (data.type === "model_summary") {
                        displayModelSummary(data.summary, data.model === "model1" ? 1 : 2, data.config);
                        // Start timer immediately after receiving model summary
                        if (data.model === "model1" && !startTime1) {
                            startTime1 = Date.now();
                            timer1Interval = setInterval(updateTimer1, 1000);
                        } else if (data.model === "model2" && !startTime2) {
                            startTime2 = Date.now();
                            timer2Interval = setInterval(updateTimer2, 1000);
                        }
                        return;
                    }

                    // Update progress bars and status
                    if (data.model === "model1") {
                        const progress = data.progress1 || 0;  // Use 0 if progress1 is undefined
                        document.getElementById('progress1').style.width = `${progress}%`;
                        document.getElementById('progress1').textContent = `${progress}%`;
                        document.getElementById('status1').textContent = 
                            `Epoch ${data.epoch || 0}/${data.total_epochs || 0}, Batch ${data.batch || 0}/${data.total_batches || 0}`;
                        document.querySelector('#metrics1 .loss').textContent = 
                            `Loss: ${(data.current_loss || 0).toFixed(4)}`;
                        document.querySelector('#metrics1 .accuracy').textContent = 
                            `Accuracy: ${(data.current_acc || 0).toFixed(2)}%`;
                        document.querySelector('#metrics1 .learning-rate').textContent = 
                            `LR: ${(data.current_lr || 0).toExponential(2)}`;
                    } else {
                        const progress = data.progress2 || 0;  // Use 0 if progress2 is undefined
                        document.getElementById('progress2').style.width = `${progress}%`;
                        document.getElementById('progress2').textContent = `${progress}%`;
                        document.getElementById('status2').textContent = 
                            `Epoch ${data.epoch || 0}/${data.total_epochs || 0}, Batch ${data.batch || 0}/${data.total_batches || 0}`;
                        document.querySelector('#metrics2 .loss').textContent = 
                            `Loss: ${(data.current_loss || 0).toFixed(4)}`;
                        document.querySelector('#metrics2 .accuracy').textContent = 
                            `Accuracy: ${(data.current_acc || 0).toFixed(2)}%`;
                        document.querySelector('#metrics2 .learning-rate').textContent = 
                            `LR: ${(data.current_lr || 0).toExponential(2)}`;
                    }

                    // Update plots
                    updatePlots(data);
                });

                socket.on('training_complete', function(data) {
                    // Stop timer for the completed model
                    if (data.model === "model1") {
                        if (timer1Interval) {
                            clearInterval(timer1Interval);
                            timer1Interval = null;
                            startTime1 = null;  // Reset start time
                        }
                    } else if (data.model === "model2") {
                        if (timer2Interval) {
                            clearInterval(timer2Interval);
                            timer2Interval = null;
                            startTime2 = null;  // Reset start time
                        }
                    }

                    // Only re-enable buttons when both models are complete
                    if (data.status === "all_complete") {
                        isTraining = false;
                        document.getElementById('train-button').disabled = false;
                        document.getElementById('stop-button').disabled = true;
                        document.getElementById('test-button').disabled = false;
                        document.getElementById('train-metrics-button').disabled = false;
                        document.getElementById('test-metrics-button').disabled = false;
                    }
                });

                socket.on('training_error', function(data) {
                    console.error('Training error:', data.error);
                    alert('Error during training: ' + data.error);
                    isTraining = false;
                    document.getElementById('train-button').disabled = false;
                    document.getElementById('stop-button').disabled = true;
                });

                // Add training_stopped handler here inside startTraining
                socket.on('training_stopped', function(data) {
                    console.log('Training stopped by server');
                    isTraining = false;
                    document.getElementById('train-button').disabled = false;
                    document.getElementById('stop-button').disabled = true;
                });

                // Wait for socket to connect
                await new Promise((resolve, reject) => {
                    socket.on('connect', resolve);
                    socket.on('connect_error', reject);
                    // Add timeout
                    setTimeout(() => reject(new Error('Socket connection timeout')), 5000);
                });

                // Start the training process
                const formData = new FormData();
                document.querySelectorAll('#model1-form input, #model1-form select').forEach(input => {
                    formData.append(input.name, input.value);
                });
                document.querySelectorAll('#model2-form input, #model2-form select').forEach(input => {
                    formData.append(input.name, input.value);
                });

                const params = new URLSearchParams(formData);
                const response = await fetch(`/train?${params.toString()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                isTraining = true;
                document.getElementById('train-button').disabled = true;
                document.getElementById('stop-button').disabled = false;
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error starting training: ' + error.message);
                isTraining = false;
                document.getElementById('train-button').disabled = false;
                document.getElementById('stop-button').disabled = true;
                document.getElementById('status1').textContent = 'Error starting training';
                document.getElementById('status2').textContent = 'Error starting training';
            }
        }

        async function stopTraining() {
            try {
                const response = await fetch('/stop_training');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Disable stop button and enable train button
                document.getElementById('stop-button').disabled = true;
                document.getElementById('train-button').disabled = false;
                
                // Reset UI
                resetUI();
                
                // Reset timer variables
                startTime1 = null;
                startTime2 = null;
                if (timer1Interval) {
                    clearInterval(timer1Interval);
                    timer1Interval = null;
                }
                if (timer2Interval) {
                    clearInterval(timer2Interval);
                    timer2Interval = null;
                }
                
                // Reset data
                model1Data = {
                    train_losses: [],
                    train_accuracies: [],
                    val_losses: [],
                    val_accuracies: []
                };
                model2Data = {
                    train_losses: [],
                    train_accuracies: [],
                    val_losses: [],
                    val_accuracies: []
                };
                
                // Close and remove socket connection
                if (socket) {
                    socket.off('plot_update');  // Remove all plot_update listeners
                    socket.off('training_complete');  // Remove all training_complete listeners
                    socket.off('training_error');  // Remove all training_error listeners
                    socket.close();
                    socket = null;
                }
                
                isTraining = false;
            } catch (error) {
                console.error('Error stopping training:', error);
            }
        }

        function resetUI() {
            // Reset progress bars
            document.getElementById('progress1').style.width = '0%';
            document.getElementById('progress1').textContent = '0%';
            document.getElementById('progress2').style.width = '0%';
            document.getElementById('progress2').textContent = '0%';
            
            // Reset status
            document.getElementById('status1').textContent = 'Training stopped';
            document.getElementById('status2').textContent = 'Training stopped';
            
            // Reset metrics
            document.querySelector('#metrics1 .loss').textContent = 'Loss: -';
            document.querySelector('#metrics1 .accuracy').textContent = 'Accuracy: -';
            document.querySelector('#metrics2 .loss').textContent = 'Loss: -';
            document.querySelector('#metrics2 .accuracy').textContent = 'Accuracy: -';
            
            // Clear plots
            initPlots();
            
            // Reset timers display
            document.getElementById('timer1').textContent = 'Time: 00:00:00';
            document.getElementById('timer2').textContent = 'Time: 00:00:00';
            
            // Clear model summaries
            document.querySelectorAll('.model-summary').forEach(el => el.remove());
        }

        async function showTestResults() {
            try {
                const response = await fetch('/get_test_results');
                const data = await response.json();
                
                const resultsDiv = document.querySelector('.results-grid');
                resultsDiv.innerHTML = '';
                
                for (let i = 0; i < data.true_labels.length; i++) {
                    const isModel1Correct = data.model1_preds[i] === data.true_labels[i];
                    const isModel2Correct = data.model2_preds[i] === data.true_labels[i];
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = `result-item ${isModel1Correct && isModel2Correct ? 'correct' : 'incorrect'}`;
                    resultItem.innerHTML = `
                        <div class="result-content">
                            <div class="digit-image">
                                <img src="data:image/png;base64,${data.images[i]}" alt="MNIST digit">
                            </div>
                            <div class="predictions">
                                <p class="true-label"><strong>True Label:</strong> ${data.true_labels[i]}</p>
                                <p class="model-pred" style="color: ${isModel1Correct ? '#2ecc71' : '#e74c3c'}">
                                    <strong>Model 1 Prediction:</strong> ${data.model1_preds[i]}
                                </p>
                                <p class="model-pred" style="color: ${isModel2Correct ? '#2ecc71' : '#e74c3c'}">
                                    <strong>Model 2 Prediction:</strong> ${data.model2_preds[i]}
                                </p>
                            </div>
                        </div>
                    `;
                    resultsDiv.appendChild(resultItem);
                }
                
                document.getElementById('test-results').style.display = 'block';
                document.getElementById('model-metrics').style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function showModelMetrics(dataType) {
            try {
                // Disable buttons while loading
                document.getElementById('train-metrics-button').disabled = true;
                document.getElementById('test-metrics-button').disabled = true;

                const response = await fetch(`/get_model_metrics?data_type=${dataType}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Update title based on data type
                document.querySelector('#model-metrics h2').textContent = 
                    `Model Metrics (${dataType.charAt(0).toUpperCase() + dataType.slice(1)} Data)`;
                
                // Plot confusion matrices
                plotConfusionMatrix('confusion-matrix1', data.model1.confusion_matrix, 
                    `Model 1 - ${dataType} Confusion Matrix`);
                plotConfusionMatrix('confusion-matrix2', data.model2.confusion_matrix, 
                    `Model 2 - ${dataType} Confusion Matrix`);
                
                // Display metrics
                displayMetrics('model1-scores', data.model1);
                displayMetrics('model2-scores', data.model2);
                
                // Show metrics div and hide test results
                document.getElementById('model-metrics').style.display = 'block';
                document.getElementById('test-results').style.display = 'none';

            } catch (error) {
                console.error('Error:', error);
                alert('Error getting metrics. Make sure models are trained first.');
            } finally {
                // Re-enable buttons
                document.getElementById('train-metrics-button').disabled = false;
                document.getElementById('test-metrics-button').disabled = false;
            }
        }

        function displayMetrics(elementId, metrics) {
            const container = document.getElementById(elementId);
            if (!container) {
                console.error(`Element with id ${elementId} not found`);
                return;
            }

            container.innerHTML = `
                <div class="metric-item">
                    <div class="label">Accuracy</div>
                    <div class="value">${(metrics.accuracy * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-item">
                    <div class="label">Precision</div>
                    <div class="value">${(metrics.precision * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-item">
                    <div class="label">Recall</div>
                    <div class="value">${(metrics.recall * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-item">
                    <div class="label">F1 Score</div>
                    <div class="value">${(metrics.f1_score * 100).toFixed(2)}%</div>
                </div>
            `;
        }

        function plotConfusionMatrix(elementId, matrix, title) {
            if (!matrix || !Array.isArray(matrix)) {
                console.error('Invalid matrix data:', matrix);
                return;
            }

            const data = [{
                z: matrix,
                x: ['Predicted 0', 'Predicted 1', 'Predicted 2', 'Predicted 3', 'Predicted 4',
                    'Predicted 5', 'Predicted 6', 'Predicted 7', 'Predicted 8', 'Predicted 9'],
                y: ['Actual 0', 'Actual 1', 'Actual 2', 'Actual 3', 'Actual 4',
                    'Actual 5', 'Actual 6', 'Actual 7', 'Actual 8', 'Actual 9'],
                type: 'heatmap',
                colorscale: 'Viridis',
                showscale: true,
                text: matrix.map(row => row.map(String)),
                texttemplate: '%{text}',
                textfont: {color: 'white'},
                hoverongaps: false,
                hovertemplate: 'Actual: %{y}<br>Predicted: %{x}<br>Count: %{z}<extra></extra>'
            }];

            const layout = {
                title: title,
                height: 500,
                width: 500,
                margin: {
                    t: 50,
                    l: 100,
                    r: 50,
                    b: 100
                },
                xaxis: {
                    title: 'Predicted Label',
                    side: 'bottom',
                    tickangle: 45
                },
                yaxis: {
                    title: 'Actual Label'
                },
                annotations: []
            };

            // Add text annotations for each cell
            for (let i = 0; i < matrix.length; i++) {
                for (let j = 0; j < matrix[i].length; j++) {
                    const value = matrix[i][j];
                    const textColor = value > matrix.flat().reduce((a, b) => a + b) / (matrix.length * matrix.length) * 2 
                        ? 'white' 
                        : 'black';
                    
                    layout.annotations.push({
                        x: j,
                        y: i,
                        text: value,
                        font: {
                            color: textColor,
                            size: 10
                        },
                        showarrow: false,
                        xref: 'x',
                        yref: 'y'
                    });
                }
            }

            try {
                Plotly.newPlot(elementId, data, layout, {
                    responsive: true,
                    displayModeBar: false
                });
            } catch (error) {
                console.error('Error plotting confusion matrix:', error);
            }
        }

        // Add this function to format the model summary
        function displayModelSummary(summary, modelNum, config) {
            // Remove any existing summary for this model
            const existingSummary = document.querySelector(`.progress-section:nth-child(${modelNum}) .model-summary`);
            if (existingSummary) {
                existingSummary.remove();
            }

            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'model-summary';
            
            // Add model configuration
            let summaryHTML = `
                <h4>Model ${modelNum} Configuration:</h4>
                <div class="config-details">
                    <p>Conv1 Layers: ${config.conv1}</p>
                    <p>Conv2 Layers: ${config.conv2}</p>
                    <p>Conv3 Layers: ${config.conv3}</p>
                    <p>Optimizer: ${config.optimizer}</p>
                    <p>Batch Size: ${config.batch_size}</p>
                    <p>Epochs: ${config.epochs}</p>
                </div>
                <h4>Layer Details:</h4>
                <table class="layer-table">
                    <thead>
                        <tr>
                            <th>Layer</th>
                            <th>Type</th>
                            <th>Shape</th>
                            <th>Parameters</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add layer details
            summary.layers.forEach(layer => {
                summaryHTML += `
                    <tr>
                        <td>${layer.layer}</td>
                        <td>${layer.type}</td>
                        <td>${layer.shape ? layer.shape.join(' × ') : '-'}</td>
                        <td>${layer.params.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            // Add total parameters
            summaryHTML += `
                    </tbody>
                </table>
                <div class="total-params">
                    <p>Total Parameters: ${summary.total_params.toLocaleString()}</p>
                    <p>Trainable Parameters: ${summary.trainable_params.toLocaleString()}</p>
                </div>
            `;
            
            summaryDiv.innerHTML = summaryHTML;
            
            // Insert the summary before the progress section
            const progressSection = document.querySelector(`.progress-section:nth-child(${modelNum})`);
            progressSection.insertBefore(summaryDiv, progressSection.firstChild);
        }

        // Clean up socket connection when page is unloaded
        window.onbeforeunload = function() {
            if (socket) {
                socket.disconnect();
            }
        };
    </script>
</body>
</html> 