<!DOCTYPE html>
<html>
<head>
    <title>MNIST CNN Models Comparison</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>MNIST CNN Models Comparison</h1>
        
        <div class="models-config">
            <div class="model-config">
                <h2>Model 1 Configuration</h2>
                <form id="model1-form">
                    <div class="form-group">
                        <label>Conv1 Layers:</label>
                        <input type="number" name="model1_conv1" value="32" min="1">
                    </div>
                    <div class="form-group">
                        <label>Conv2 Layers:</label>
                        <input type="number" name="model1_conv2" value="64" min="1">
                    </div>
                    <div class="form-group">
                        <label>Conv3 Layers:</label>
                        <input type="number" name="model1_conv3" value="128" min="1">
                    </div>
                    <div class="form-group">
                        <label>Optimizer:</label>
                        <select name="model1_optimizer">
                            <option value="adam">Adam</option>
                            <option value="sgd">SGD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Batch Size:</label>
                        <input type="number" name="model1_batch_size" value="64" min="1">
                    </div>
                    <div class="form-group">
                        <label>Epochs:</label>
                        <input type="number" name="model1_epochs" value="10" min="1">
                    </div>
                </form>
            </div>
            
            <div class="model-config">
                <h2>Model 2 Configuration</h2>
                <form id="model2-form">
                    <div class="form-group">
                        <label>Conv1 Layers:</label>
                        <input type="number" name="model2_conv1" value="16" min="1">
                    </div>
                    <div class="form-group">
                        <label>Conv2 Layers:</label>
                        <input type="number" name="model2_conv2" value="32" min="1">
                    </div>
                    <div class="form-group">
                        <label>Conv3 Layers:</label>
                        <input type="number" name="model2_conv3" value="64" min="1">
                    </div>
                    <div class="form-group">
                        <label>Optimizer:</label>
                        <select name="model2_optimizer">
                            <option value="adam">Adam</option>
                            <option value="sgd">SGD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Batch Size:</label>
                        <input type="number" name="model2_batch_size" value="32" min="1">
                    </div>
                    <div class="form-group">
                        <label>Epochs:</label>
                        <input type="number" name="model2_epochs" value="10" min="1">
                    </div>
                </form>
            </div>
        </div>
        
        <button id="train-button" onclick="startTraining()">Train Models</button>
        
        <div class="progress-container">
            <div class="progress-section">
                <h3>Model 1 Progress</h3>
                <div class="progress">
                    <div id="progress1" class="progress-bar" style="width: 0%">0%</div>
                </div>
                <div id="status1" class="training-status">Waiting to start...</div>
                <div id="metrics1" class="metrics">
                    <span class="loss">Loss: -</span>
                    <span class="accuracy">Accuracy: -</span>
                </div>
            </div>
            <div class="progress-section">
                <h3>Model 2 Progress</h3>
                <div class="progress">
                    <div id="progress2" class="progress-bar" style="width: 0%">0%</div>
                </div>
                <div id="status2" class="training-status">Waiting to start...</div>
                <div id="metrics2" class="metrics">
                    <span class="loss">Loss: -</span>
                    <span class="accuracy">Accuracy: -</span>
                </div>
            </div>
        </div>
        
        <div class="plots-container">
            <div class="plot">
                <h3>Loss Comparison</h3>
                <div id="loss-plot" style="width:100%; height:400px;"></div>
            </div>
            <div class="plot">
                <h3>Accuracy Comparison</h3>
                <div id="acc-plot" style="width:100%; height:400px;"></div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="test-button" onclick="showTestResults()">Test Results</button>
            <button id="train-metrics-button" onclick="showModelMetrics('train')">Training Metrics</button>
            <button id="test-metrics-button" onclick="showModelMetrics('test')">Test Metrics</button>
        </div>

        <div id="test-results" class="test-results" style="display: none;">
            <h2>Test Results</h2>
            <div class="results-grid"></div>
        </div>

        <div id="model-metrics" class="model-metrics" style="display: none;">
            <h2>Model Metrics</h2>
            <div class="metrics-container">
                <div class="model-metric">
                    <h3>Model 1 Confusion Matrix</h3>
                    <div id="confusion-matrix1"></div>
                    <div id="model1-scores" class="score-metrics"></div>
                </div>
                <div class="model-metric">
                    <h3>Model 2 Confusion Matrix</h3>
                    <div id="confusion-matrix2"></div>
                    <div id="model2-scores" class="score-metrics"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <script>
        let socket;
        const model1Data = {
            losses: [],
            accuracies: []
        };
        const model2Data = {
            losses: [],
            accuracies: []
        };

        function initPlots() {
            const lossTrace1 = {
                y: [],
                x: [],
                name: 'Model 1',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#3498db'}
            };
            
            const lossTrace2 = {
                y: [],
                x: [],
                name: 'Model 2',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#e74c3c'}
            };

            const accTrace1 = {
                y: [],
                x: [],
                name: 'Model 1',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#3498db'}
            };
            
            const accTrace2 = {
                y: [],
                x: [],
                name: 'Model 2',
                type: 'scatter',
                mode: 'lines+markers',
                line: {color: '#e74c3c'}
            };

            const lossLayout = {
                title: 'Training Loss',
                xaxis: { title: 'Batch (x100)' },
                yaxis: { title: 'Loss' },
                showlegend: true,
                legend: {
                    x: 1.1,
                    xanchor: 'left',
                    y: 1,
                    yanchor: 'top',
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#E2E2E2',
                    borderwidth: 1
                },
                margin: {
                    l: 50,
                    r: 100,
                    t: 50,
                    b: 50
                }
            };

            const accLayout = {
                title: 'Training Accuracy',
                xaxis: { title: 'Batch (x100)' },
                yaxis: { title: 'Accuracy (%)' },
                showlegend: true,
                legend: {
                    x: 1.1,
                    xanchor: 'left',
                    y: 1,
                    yanchor: 'top',
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: '#E2E2E2',
                    borderwidth: 1
                },
                margin: {
                    l: 50,
                    r: 100,
                    t: 50,
                    b: 50
                }
            };

            Plotly.newPlot('loss-plot', [lossTrace1, lossTrace2], lossLayout);
            Plotly.newPlot('acc-plot', [accTrace1, accTrace2], accLayout);
        }

        function updatePlots(data) {
            const modelData = data.model === 'model1' ? model1Data : model2Data;
            modelData.losses = data.losses;
            modelData.accuracies = data.accuracies;

            const xRange = [...Array(Math.max(model1Data.losses.length, model2Data.losses.length)).keys()];

            // Update loss plot
            Plotly.update('loss-plot', {
                'x': [
                    xRange.slice(0, model1Data.losses.length),
                    xRange.slice(0, model2Data.losses.length)
                ],
                'y': [model1Data.losses, model2Data.losses]
            });

            // Update accuracy plot
            Plotly.update('acc-plot', {
                'x': [
                    xRange.slice(0, model1Data.accuracies.length),
                    xRange.slice(0, model2Data.accuracies.length)
                ],
                'y': [model1Data.accuracies, model2Data.accuracies]
            });
        }

        async function startTraining() {
            // Reset UI state
            document.getElementById('train-button').disabled = true;
            document.getElementById('progress1').style.width = '0%';
            document.getElementById('progress1').textContent = '0%';
            document.getElementById('progress2').style.width = '0%';
            document.getElementById('progress2').textContent = '0%';
            document.getElementById('status1').textContent = 'Waiting to start...';
            document.getElementById('status2').textContent = 'Waiting to start...';
            document.getElementById('test-results').style.display = 'none';

            // Initialize plots
            initPlots();

            // Setup WebSocket connection
            socket = io();

            socket.on('plot_update', function(data) {
                // Update progress bars and status
                if (data.model === "model1") {
                    document.getElementById('progress1').style.width = `${data.progress1}%`;
                    document.getElementById('progress1').textContent = `${data.progress1}%`;
                    document.getElementById('status1').textContent = 
                        `Epoch ${data.epoch}/${data.total_epochs}, Batch ${data.batch}/${data.total_batches}`;
                    document.querySelector('#metrics1 .loss').textContent = 
                        `Loss: ${data.current_loss.toFixed(4)}`;
                    document.querySelector('#metrics1 .accuracy').textContent = 
                        `Accuracy: ${data.current_acc.toFixed(2)}%`;
                } else {
                    document.getElementById('progress2').style.width = `${data.progress2}%`;
                    document.getElementById('progress2').textContent = `${data.progress2}%`;
                    document.getElementById('status2').textContent = 
                        `Epoch ${data.epoch}/${data.total_epochs}, Batch ${data.batch}/${data.total_batches}`;
                    document.querySelector('#metrics2 .loss').textContent = 
                        `Loss: ${data.current_loss.toFixed(4)}`;
                    document.querySelector('#metrics2 .accuracy').textContent = 
                        `Accuracy: ${data.current_acc.toFixed(2)}%`;
                }

                // Update plots
                updatePlots(data);
            });

            socket.on('training_complete', function(data) {
                trainedModel1 = data.model1;
                trainedModel2 = data.model2;
                document.getElementById('test-button').disabled = false;
                document.getElementById('metrics-button').disabled = false;
                document.getElementById('train-button').disabled = false;
            });

            // Collect and send form data
            const formData = new FormData();
            document.querySelectorAll('#model1-form input, #model1-form select').forEach(input => {
                formData.append(input.name, input.value);
            });
            document.querySelectorAll('#model2-form input, #model2-form select').forEach(input => {
                formData.append(input.name, input.value);
            });

            try {
                const params = new URLSearchParams(formData);
                await fetch(`/train?${params.toString()}`);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('train-button').disabled = false;
            }
        }

        async function showTestResults() {
            try {
                const response = await fetch('/get_test_results');
                const data = await response.json();
                
                const resultsDiv = document.querySelector('.results-grid');
                resultsDiv.innerHTML = '';
                
                for (let i = 0; i < data.true_labels.length; i++) {
                    const isModel1Correct = data.model1_preds[i] === data.true_labels[i];
                    const isModel2Correct = data.model2_preds[i] === data.true_labels[i];
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = `result-item ${isModel1Correct && isModel2Correct ? 'correct' : 'incorrect'}`;
                    resultItem.innerHTML = `
                        <p><strong>True Label:</strong> ${data.true_labels[i]}</p>
                        <p style="color: ${isModel1Correct ? '#2ecc71' : '#e74c3c'}">
                            <strong>Model 1 Prediction:</strong> ${data.model1_preds[i]}
                        </p>
                        <p style="color: ${isModel2Correct ? '#2ecc71' : '#e74c3c'}">
                            <strong>Model 2 Prediction:</strong> ${data.model2_preds[i]}
                        </p>
                    `;
                    resultsDiv.appendChild(resultItem);
                }
                
                document.getElementById('test-results').style.display = 'block';
                document.getElementById('model-metrics').style.display = 'none';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function showModelMetrics(dataType) {
            try {
                // Disable buttons while loading
                document.getElementById('train-metrics-button').disabled = true;
                document.getElementById('test-metrics-button').disabled = true;

                const response = await fetch(`/get_model_metrics?data_type=${dataType}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Update title based on data type
                document.querySelector('#model-metrics h2').textContent = 
                    `Model Metrics (${dataType.charAt(0).toUpperCase() + dataType.slice(1)} Data)`;
                
                // Plot confusion matrices
                plotConfusionMatrix('confusion-matrix1', data.model1.confusion_matrix, 
                    `Model 1 - ${dataType} Confusion Matrix`);
                plotConfusionMatrix('confusion-matrix2', data.model2.confusion_matrix, 
                    `Model 2 - ${dataType} Confusion Matrix`);
                
                // Display metrics
                displayMetrics('model1-scores', data.model1);
                displayMetrics('model2-scores', data.model2);
                
                // Show metrics div and hide test results
                document.getElementById('model-metrics').style.display = 'block';
                document.getElementById('test-results').style.display = 'none';

            } catch (error) {
                console.error('Error:', error);
                alert('Error getting metrics. Make sure models are trained first.');
            } finally {
                // Re-enable buttons
                document.getElementById('train-metrics-button').disabled = false;
                document.getElementById('test-metrics-button').disabled = false;
            }
        }

        function displayMetrics(elementId, metrics) {
            const container = document.getElementById(elementId);
            if (!container) {
                console.error(`Element with id ${elementId} not found`);
                return;
            }

            container.innerHTML = `
                <div class="metric-item">
                    <div class="label">Accuracy</div>
                    <div class="value">${(metrics.accuracy * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-item">
                    <div class="label">Precision</div>
                    <div class="value">${(metrics.precision * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-item">
                    <div class="label">Recall</div>
                    <div class="value">${(metrics.recall * 100).toFixed(2)}%</div>
                </div>
                <div class="metric-item">
                    <div class="label">F1 Score</div>
                    <div class="value">${(metrics.f1_score * 100).toFixed(2)}%</div>
                </div>
            `;
        }

        function plotConfusionMatrix(elementId, matrix, title) {
            if (!matrix || !Array.isArray(matrix)) {
                console.error('Invalid matrix data:', matrix);
                return;
            }

            const data = [{
                z: matrix,
                x: ['Predicted 0', 'Predicted 1', 'Predicted 2', 'Predicted 3', 'Predicted 4',
                    'Predicted 5', 'Predicted 6', 'Predicted 7', 'Predicted 8', 'Predicted 9'],
                y: ['Actual 0', 'Actual 1', 'Actual 2', 'Actual 3', 'Actual 4',
                    'Actual 5', 'Actual 6', 'Actual 7', 'Actual 8', 'Actual 9'],
                type: 'heatmap',
                colorscale: 'Viridis',
                showscale: true,
                text: matrix.map(row => row.map(String)),
                texttemplate: '%{text}',
                textfont: {color: 'white'},
                hoverongaps: false,
                hovertemplate: 'Actual: %{y}<br>Predicted: %{x}<br>Count: %{z}<extra></extra>'
            }];

            const layout = {
                title: title,
                height: 500,
                width: 500,
                margin: {
                    t: 50,
                    l: 100,
                    r: 50,
                    b: 100
                },
                xaxis: {
                    title: 'Predicted Label',
                    side: 'bottom',
                    tickangle: 45
                },
                yaxis: {
                    title: 'Actual Label'
                },
                annotations: []
            };

            // Add text annotations for each cell
            for (let i = 0; i < matrix.length; i++) {
                for (let j = 0; j < matrix[i].length; j++) {
                    const value = matrix[i][j];
                    const textColor = value > matrix.flat().reduce((a, b) => a + b) / (matrix.length * matrix.length) * 2 
                        ? 'white' 
                        : 'black';
                    
                    layout.annotations.push({
                        x: j,
                        y: i,
                        text: value,
                        font: {
                            color: textColor,
                            size: 10
                        },
                        showarrow: false,
                        xref: 'x',
                        yref: 'y'
                    });
                }
            }

            try {
                Plotly.newPlot(elementId, data, layout, {
                    responsive: true,
                    displayModeBar: false
                });
            } catch (error) {
                console.error('Error plotting confusion matrix:', error);
            }
        }

        // Clean up socket connection when page is unloaded
        window.onbeforeunload = function() {
            if (socket) {
                socket.disconnect();
            }
        };
    </script>
</body>
</html> 